<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet-search.css">
        <link rel="stylesheet" href="css/filter.css">
        <link rel="stylesheet" href="css/nouislider.min.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <style>
            /* Dashboard 核心佈局 */
            html, body { height: 100%; margin: 0; font-family: "Microsoft JhengHei", sans-serif; display: flex; flex-direction: column; overflow: hidden; }
            
            /* 上方標題與篩選列 */
            #header { 
                height: 60px; background: #2c3e50; color: white; display: flex; 
                align-items: center; padding: 0 20px; z-index: 1000; justify-content: space-between;
            }
            #filter-bar { display: flex; gap: 15px; align-items: center; }
            #filter-bar select { padding: 5px 10px; border-radius: 4px; border: none; font-size: 0.9em; }

            #main-container { display: flex; flex: 1; overflow: hidden; }
            
            /* 左側清單 */
            #left-sidebar { width: 300px; background: #f4f4f4; border-right: 1px solid #ccc; display: flex; flex-direction: column; }
            .sidebar-header { background: #34495e; color: white; padding: 10px; font-size: 1.0em; font-weight: bold; }
            #event-list { flex: 1; overflow-y: auto; }
            .event-item { padding: 12px; border-bottom: 1px solid #ddd; cursor: pointer; transition: 0.2s; background: white; }
            .event-item:hover { background: #eef2f7; }
            .event-type { font-weight: bold; color: #e67e22; margin-bottom: 4px; font-size: 1.0em; }
            #total-panel { height: 60px; background: white; border-top: 2px solid #2c3e50; display: flex; flex-direction: column; align-items: center; justify-content: center; }
            #count-num { font-size: 1.5em; color: #e74c3c; font-weight: bold; }

            /* 中間地圖 */
            #map { flex: 1; z-index: 1; position: relative; }

            /* 右側詳情 */
            #right-sidebar { width: 320px; background: white; border-left: 1px solid #ccc; overflow-y: auto; }
            .detail-header { background: #2c3e50; color: white; padding: 10px; font-weight: bold; }
            #detail-content { padding: 15px; font-size: 0.9em; line-height: 1.6; }

            /* 指北針樣式 */
            .compass-control {
                background: white; border: 2px solid rgba(0,0,0,0.2); border-radius: 4px;
                padding: 5px; cursor: default;
            }
            .compass-control img { width: 40px; height: 40px; }

            /* 地圖圖例 */
            .map-legend { background: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.2); line-height: 1.5; font-size: 14px; }
            .legend-item { display: flex; align-items: center; margin-bottom: 3px; }
            .legend-color { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; border: 1px solid #666; }

            /* 隱藏原本 qgis2web 生成的舊介面 */
            #all, #menu { display: none !important; }
        </style>
        <title>桃園市歷史災害儀表板</title>
    </head>
    <body>
        <header id="header">
            <div>桃園市歷史災害儀表板</div>
            <div id="filter-bar">
                <span>篩選條件：</span>
                <select id="sel-year" onchange="applyFilters()">
                    <option value="全部">全部年份</option>
                    <option value="114">114 年</option>
                    <option value="113">113 年</option>
                    <option value="112">112 年</option>
                    <option value="111">111 年</option>
                    <option value="110">110 年</option>
                    <option value="109">109 年</option>
                    <option value="108">108 年</option>
                    <option value="107">107 年</option>
                </select>
                <select id="sel-type" onchange="applyFilters()">
                    <option value="全部">全部類別</option>
                    <option value="水災">水災</option>
                    <option value="坡災">坡災</option>
                    <option value="風災">風災</option>
                    <option value="震災">震災</option>
                    <option value="雷擊">雷擊</option>
                </select>
            </div>
        </header>
        
        <div id="main-container">
            <aside id="left-sidebar">
                <div class="sidebar-header">災害事件列表</div>
                <div id="event-list">資料載入中...</div>
                <div id="total-panel">
                    <small>符合條件總計</small>
                    <div><span id="count-num">0</span> 筆</div>
                </div>
            </aside>

            <div id="map"></div>

            <aside id="right-sidebar">
                <div class="detail-header">災害事件詳細資訊</div>
                <div id="detail-content">請點擊地圖點位或清單查看詳情</div>
            </aside>
        </div>

        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="data/114___1.js"></script>
        <script src="data/disaster_data.js"></script>

        <script>
            var map, layer___2, layer_114___1;

            window.onload = function() {
                if (typeof json___2 === 'undefined') {
                    document.getElementById('event-list').innerHTML = "無法載入資料 (json___2 defined 錯誤)";
                    return;
                }

                // 1. 初始化地圖
                map = L.map('map', {
                    zoomControl: true, maxZoom: 28, minZoom: 1
                }).fitBounds([[24.6081917, 120.938447], [25.1121815, 121.744594]]);

                // 2. 設定 Pane
                map.createPane('pane_114___1');
                map.getPane('pane_114___1').style.zIndex = 401;
                map.createPane('pane___2');
                map.getPane('pane___2').style.zIndex = 402;

                // 3. 載入底圖
                L.tileLayer('https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}').addTo(map);

                // 4. 載入行政區邊界
                layer_114___1 = L.geoJson(json_114___1, {
                    pane: 'pane_114___1',
                    style: { color: '#333', weight: 1, fillOpacity: 0.05, fillColor: '#000' },
                    interactive: false
                }).addTo(map);

                // 5. 載入災害點位
                layer___2 = L.geoJson(json___2, {
                    pane: 'pane___2',
                    pointToLayer: function (feature, latlng) {
                        var colors = {'水災': '#1f94f4', '坡災': '#23db66', '風災': '#e6211d', '震災': '#ffad00', '雷擊': '#ff9afe'};
                        return L.circleMarker(latlng, {
                            radius: 6.5, opacity: 1, color: 'white', weight: 1.5, fillOpacity: 1,
                            fillColor: colors[feature.properties['災害類別']] || '#999'
                        });
                    },
                    onEachFeature: function(feature, layer) {
                        layer.on('click', function() { showDetail(feature.properties); });
                    }
                }).addTo(map);

                // 6. 新增圖例
                var legend = L.control({position: 'bottomright'});
                legend.onAdd = function (map) {
                    var div = L.DomUtil.create('div', 'map-legend');
                    div.innerHTML = '<strong>圖例</strong><br>' +
                        '<div class="legend-item"><div class="legend-color" style="background:#1f94f4"></div>水災</div>' +
                        '<div class="legend-item"><div class="legend-color" style="background:#23db66"></div>坡災</div>' +
                        '<div class="legend-item"><div class="legend-color" style="background:#e6211d"></div>風災</div>' +
                        '<div class="legend-item"><div class="legend-color" style="background:#ffad00"></div>震災</div>' +
                        '<div class="legend-item"><div class="legend-color" style="background:#ff9afe"></div>雷擊</div>';
                    return div;
                };
                legend.addTo(map);

                applyFilters(); // 執行初始渲染
            };

            // 核心篩選邏輯
            function applyFilters() {
                var selYear = document.getElementById('sel-year').value;
                var selType = document.getElementById('sel-type').value;

                layer___2.clearLayers();

                var filteredData = json___2.features.filter(function(f) {
                    var mYear = (selYear === "全部" || String(f.properties['災害發生年(民國)']) === selYear);
                    var mType = (selType === "全部" || f.properties['災害類別'] === selType);
                    return mYear && mType;
                });

                layer___2.addData(filteredData);
                updateList();
            }

            // 更新左側清單與統計
            function updateList() {
                var listHtml = "";
                var count = 0;
                layer___2.eachLayer(function(l) {
                    count++;
                    var p = l.feature.properties;
                    listHtml += `
                        <div class="event-item" onclick="zoomToLayer(${l._leaflet_id})">
                            <div class="event-type">${p['災害類別']} - ${p['災害事件'] || '無詳細資料'}</div>
                            <small>${p['災害區域'] || '未知區域'} | 民國 ${p['災害發生年(民國)']} 年</small>
                        </div>`;
                });
                document.getElementById('event-list').innerHTML = listHtml || '<div style="padding:20px; color:#999;">無符合條件的資料</div>';
                document.getElementById('count-num').innerText = count;
            }

            // 點擊清單定位功能
            window.zoomToLayer = function(id) {
                var l = layer___2.getLayer(id);
                map.setView(l.getLatLng(), 16);
                showDetail(l.feature.properties);
                l.openPopup(); 
            };

            // 詳情面板渲染
            function showDetail(props) {
                // 定義您想要顯示的欄位名稱（必須與 SHP 屬性表欄位名稱完全一致）
                var targetFields = [
                    '災害區域', 
                    '村里', 
                    '災害類別', 
                    '災害發生年(民國)', 
                    '發生日期(民國)', 
                    '災害情況說明'
                ];

                var html = `<table style="width:100%; border-collapse:collapse;">`;
                // 遍歷指定的欄位
                targetFields.forEach(function(key) {
                    // 檢查資料中是否有該欄位，且內容不為空
                    if (props.hasOwnProperty(key)) {
                        var value = (props[key] !== null) ? props[key] : "無資料";
                        html += `<tr style="border-bottom:1px solid #eee;">
                                    <td style="padding:10px; color:#666; width:120px; font-size:0.9em; background:#fcfcfc;">${key}</td>
                                    <td style="padding:10px; font-weight:bold; color:#333; font-size:0.95em;">${value}</td>
                                 </tr>`;
                    }
                });

                html += `</table>`;
                document.getElementById('detail-content').innerHTML = html;
                
                    
            
            }
        </script>
    </body>
</html>
