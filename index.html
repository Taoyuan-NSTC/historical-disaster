<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet-search.css">
        <link rel="stylesheet" href="css/filter.css">
        <link rel="stylesheet" href="css/nouislider.min.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <style>
            /* Dashboard 核心佈局 */
            html, body { height: 100%; margin: 0; font-family: "Microsoft JhengHei", sans-serif; display: flex; flex-direction: column; overflow: hidden; }
            #header { height: 50px; background: #2c3e50; color: white; display: flex; align-items: center; padding: 0 20px; font-weight: bold; font-size: 1.2em; z-index: 1000; }
            #main-container { display: flex; flex: 1; overflow: hidden; }
            
            /* 左側列表 */
            #left-sidebar { width: 300px; background: #f4f4f4; border-right: 1px solid #ccc; display: flex; flex-direction: column; }
            .sidebar-header { background: #34495e; color: white; padding: 10px; font-size: 0.9em; }
            #event-list { flex: 1; overflow-y: auto; }
            .event-item { padding: 12px; border-bottom: 1px solid #ddd; cursor: pointer; transition: 0.2s; }
            .event-item:hover { background: #e9ecef; }
            .event-type { font-weight: bold; color: #e67e22; margin-bottom: 4px; }
            #total-panel { height: 60px; background: white; border-top: 2px solid #2c3e50; display: flex; flex-direction: column; align-items: center; justify-content: center; }
            #count-num { font-size: 1.5em; color: #e74c3c; font-weight: bold; }

            /* 中間地圖 */
            #map { flex: 1; z-index: 1; }

            /* 右側詳情 */
            #right-sidebar { width: 320px; background: white; border-left: 1px solid #ccc; overflow-y: auto; }
            .detail-header { background: #e74c3c; color: white; padding: 10px; font-weight: bold; }
            #detail-content { padding: 15px; font-size: 0.9em; line-height: 1.6; }

            /* 隱藏原本 qgis2web 生成的舊選單 */
            #all, #menu { display: none !important; }
        </style>
        <title>桃園市歷史災害儀表板</title>
    </head>
    <body>
        <div id="header">桃園市災害清冊儀表板</div>
        
        <div id="main-container">
            <aside id="left-sidebar">
                <div class="sidebar-header">災害事件列表</div>
                <div id="event-list">載入資料中...</div>
                <div id="total-panel">
                    <small>總計</small>
                    <div><span id="count-num">0</span> 筆</div>
                </div>
            </aside>

            <div id="map"></div>

            <aside id="right-sidebar">
                <div class="detail-header">災害事件詳細資訊</div>
                <div id="detail-content">請點擊地圖點位查看詳情</div>
            </aside>
        </div>

        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="js/leaflet-search.js"></script>
        <script src="js/nouislider.min.js"></script>
        <script src="js/wNumb.js"></script>
        <script src="data/114___1.js"></script>
        <script src="data/__2.js"></script>

        <script>
            // 1. 初始化地圖
            var map = L.map('map', {
                zoomControl: true, maxZoom: 28, minZoom: 1
            }).fitBounds([[24.6081917, 120.938447], [25.1121815, 121.744594]]);

            // 2. 設定 Pane (防止點位消失在底圖下)
            map.createPane('pane_114___1');
            map.getPane('pane_114___1').style.zIndex = 401;
            map.createPane('pane___2');
            map.getPane('pane___2').style.zIndex = 402;

            // 3. 底圖載入
            var layer_GoogleMaps = L.tileLayer('https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}', {
                opacity: 1.0, attribution: ''
            }).addTo(map);

            // 4. 樣式定義 (114_鄉鎮市區)
            function style_114___1_0() {
                return { pane: 'pane_114___1', opacity: 1, color: 'rgba(0,0,0,1.0)', weight: 1.0, fill: true, fillOpacity: 0.1, fillColor: 'rgba(255,255,255,0)' };
            }

            // 5. 樣式定義 (災害點位)
            function style___2_0(feature) {
                var colors = {'水災': '#1f94f4', '坡災': '#23db66', '風災': '#e6211d', '震災': '#ffad00', '雷擊': '#ff9afe'};
                return {
                    pane: 'pane___2', radius: 6.0, opacity: 1, color: 'white', weight: 1.5, fill: true,
                    fillOpacity: 1, fillColor: colors[feature.properties['災害類別']] || '#999', interactive: true
                };
            }

            // 6. 載入行政區邊界
            var layer_114___1 = new L.geoJson(json_114___1, {
                style: style_114___1_0,
                interactive: false
            }).addTo(map);

            // 7. 載入災害點位
            var layer___2 = new L.geoJson(json___2, {
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, style___2_0(feature));
                },
                onEachFeature: function(feature, layer) {
                    layer.on('click', function() {
                        showDetail(feature.properties);
                    });
                }
            }).addTo(map);

            // 8. 儀表板更新邏輯 (側邊清單與筆數)
            function updateDashboard() {
                var listContent = "";
                var count = 0;

                layer___2.eachLayer(function(layer) {
                    var props = layer.feature.properties;
                    count++;
                    listContent += `
                        <div class="event-item" onclick="zoomTo(${layer._leaflet_id})">
                            <div class="event-type">${props['災害類別']} - ${props['災害事件'] || '未具名事件'}</div>
                            <small>${props['災害區域'] || '未定義區域'} | 民國 ${props['災害發生年(民國)']} 年</small>
                        </div>`;
                });

                document.getElementById('event-list').innerHTML = listContent;
                document.getElementById('count-num').innerText = count;
            }

            // 9. 點擊清單聯動功能
            window.zoomTo = function(id) {
                var layer = layer___2.getLayer(id);
                map.setView(layer.getLatLng(), 16);
                showDetail(layer.feature.properties);
                // 模擬地圖點點擊效果
                layer.openPopup(); 
            };

            // 10. 詳情面板呈現
            function showDetail(props) {
                var html = `<table style="width:100%; border-collapse:collapse;">`;
                for (var key in props) {
                    html += `<tr style="border-bottom:1px solid #eee;">
                                <td style="padding:8px; color:#666; width:110px; font-size:0.85em;">${key}</td>
                                <td style="padding:8px; font-weight:bold; color:#333;">${props[key]}</td>
                             </tr>`;
                }
                html += `</table>`;
                document.getElementById('detail-content').innerHTML = html;
            }

            // 延遲執行確保資料已注入
            setTimeout(function() {
                updateDashboard();
                if (layer___2.getLayers().length > 0) {
                    map.fitBounds(layer___2.getBounds());
                }
            }, 500);

            // 當圖層變動時自動更新統計
            map.on('overlayadd overlayremove', updateDashboard);
        </script>
    </body>
</html>
